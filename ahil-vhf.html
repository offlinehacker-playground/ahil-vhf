<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="knob.html">
<link rel="import" href="../polymer-fontawesome/polymer-fontawesome.html">

<!--
Element providing emulator for vhf stations.

##### Example

    <ahil-vhf></ahil-vhf>

@element ahil-vhf
@blurb Element providing vhf emulator
@status alpha
@homepage http://polymerlabs.github.io/ahil-vhf
-->
<polymer-element name="ahil-vhf" attributes="on channel lightning volume mute sq inter power screen addressbook rxlogs">

  <template>

    <link rel="stylesheet" href="ahil-vhf.css" />

    <div class="container" horizontal layout wrap>
      <div horizontal layout>
        <div class="screen-container" vertical layout>
          <div class="screen" style = "opacity: {{lightning + 0.5}};">
            <div class="{{ {'hidden': !on} | tokenList}}">

              <template if="{{screen == 'tel'}}" >
                <div horizontal layout class="tel-container">
                  <div flex vertical layout class="tel-display">
                    <a class="tel-channel">{{ channel }}</a>
                    <div flex horizontal around-justified layout  class="tel-values" style="width: 100%">
                      <div vertical layou>
                        <header>MEM</header>
                        <footer>01</footer>
                      </div>
                      <div vertical layou>
                        <header>VOL</header>
                        <footer>{{ volume }}</footer>
                      </div>
                      <div vertical layou>
                        <header>SQ</header>
                        <footer>{{ sq }}</footer>
                      </div>
                    </div>
                  </div>
                  <div class="tel-indicator" vertical layout>
                    <a>{{ power == "1w"? "1W" : "25W" }}</a>
                    <a>{{ inter? "INT" : "US" }}</a>
                    <font-awesome icon="{{ mute? 'volume-off': 'volume-up'}}"></font-awesome>
                    <font-awesome icon="sun-o"></font-awesome>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'dsc'}}">
                <div horizontal layout class="status-container">
                  <div flex vertical layout class="status-display">
                    <header>DSC status</header>
                    <br/>
                    <a>Channel: <span>70</span></a>
                    <a>POS: <span>{{position}}</span></a>
                    <a>At UTC: <span>{{time}}</span></a>
                  </div>
                  <div class="tel-indicator" vertical layout>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'call-select'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select type of call:</header>
                    <br/>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <template if="{{screenPage == 1}}">
                      <a><font-awesome icon="circle"></font-awesome> SHORE</a>
                      <a><font-awesome icon="circle"></font-awesome> SHIP</a>
                      <a><font-awesome icon="circle"></font-awesome> LAST CALL</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>
                   <template if="{{screenPage == 2}}">
                      <a><font-awesome icon="circle"></font-awesome> ALL SHIPS</a>
                      <a><font-awesome icon="circle"></font-awesome> DISTRESS</a>
                      <a><font-awesome icon="circle"></font-awesome> EXTENDED</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="mail-reply"></font-awesome></a>
                    </template>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'call'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Key in the {{callRegion}}<br/>station MMSI<br/> number:</header>
                    <br/>
                    <table>
                      <tr>
                        <td><a>TYPE</a></td>
                        <td><a>: Individual</a></td>
                      </tr>
                      <tr>
                        <td><a>TO</a></td>
                        <td><a>: {{number}}</a></td>
                      </tr>
                    </table>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> ACCEPT</a>
                    <a><font-awesome icon="circle"></font-awesome> DIRECTORY</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="mail-reply"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'call-channel'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Key in the working channel</header>
                    <br/>
                    <table>
                      <tr>
                        <td><a>TYPE</a></td>
                        <td><a>: {{callType}}</a></td>
                      </tr>
                      <tr>
                        <td><a>TO</a></td>
                        <td><a>: {{number}}</a></td>
                      </tr>
                      <tr>
                        <td><a>AD</a></td>
                        <td><a>: Working CH {{channel}}</a></td>
                      </tr>
                    </table>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> ACCEPT</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="mail-reply"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'call-group'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Choose a working channel</header>
                    <br/>
                    <table>
                      <tr>
                        <td><a>CAT</a></td>
                        <td><a>: {{callType}}</a></td>
                      </tr>
                      <tr>
                        <td><a>TO</a></td>
                        <td><a>: {{callRegion}}</a></td>
                      </tr>
                      <tr>
                        <td><a>CH</a></td>
                        <td><a>: {{channel}}</a></td>
                      </tr>
                    </table>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> ACCEPT</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="mail-reply"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'call-group-accept'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select send<br/>to transmit</header>
                    <br/>
                    <table>
                      <tr>
                        <td><a>CAT</a></td>
                        <td><a>: {{callType}}</a></td>
                      </tr>
                      <tr>
                        <td><a>TO</a></td>
                        <td><a>: {{callRegion}}</a></td>
                      </tr>
                      <tr>
                        <td><a>CH</a></td>
                        <td><a>: {{channel}}</a></td>
                      </tr>
                    </table>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> SEND</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'call-accept'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select send<br/>to transmit</header>
                    <br/>
                    <table>
                      <tr>
                        <td><a>TO</a></td>
                        <td><a>: {{number}}</a></td>
                      </tr>
                      <tr>
                        <td><a>AD</a></td>
                        <td><a>: Working CH {{channel}}</a></td>
                      </tr>
                      <tr>
                        <td><a>ACKN</a></td>
                        <td><a>: Request</a></td>
                      </tr>
                    </table>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> SEND</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'distress'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>
                      <template if="{{distressTimeout < 0}}">
                        Select send to transmit
                      </template>
                      <template if="{{distressTimeout >= 0}}">
                        Press the DISTRESS button for <b>{{distressTimeout}}</b> seconds to transmit
                      </template>
                    </header>
                    <table>
                      <tr>
                        <td><a>TYPE</a></td>
                        <td><a>: Distress</a></td>
                      </tr>
                      <tr>
                        <td><a>MSG</a></td>
                        <td><a>: {{distressNature}}</a></td>
                      </tr>
                      <tr>
                        <td><a>POS</a></td>
                        <td><a>: {{position}}</a></td>
                      </tr>
                      <tr>
                        <td><a>TIME</a></td>
                        <td><a>: UTC {{time}}</a></td>
                      </tr>
                    </table>
                  </div>
                  <template if="{{distressTimeout < 0}}">
                    <div class="select-indicator" vertical layout>
                      <a><font-awesome icon="circle"></font-awesome> SEND</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                    </div>
                  </template>
                </div>
              </template>

              <template if="{{screen == 'distress-send'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>
                      Waiting for DISTRESS Acknowledgement
                    </header>
                    </br>
                    <table>
                      <tr>
                        <td><a>CHANNEL</a></td>
                        <td><a>: 16</a></td>
                      </tr>
                    </table>
                    Retransmit distress call every 4 minutes
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'notiffication'}}">
                <div horizontal layout>
                  <div flex vertical layout class="notiffication-display">
                    <a>{{ notifficationMessage }}</a>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'addressbook'}}">
                <div horizontal layout>

                  <template if="{{screenPage == 1}}">
                    <div flex vertical layout class="select-display">
                      <header>
                        Use
                        <font-awesome icon="angle-up"></font-awesome>
                        <font-awesome icon="angle-down"></font-awesome>
                        to search in address book
                      </header>
                      <template repeat="{{ entry, i in addressbook}}">
                        <template if="{{addressbookId == i}}">
                          <table>
                            <tr>
                              <td><a>NAME</a></td>
                              <td><a>: {{entry.name}}</a></td>
                            </tr>
                            <tr>
                              <td><a>TO</a></td>
                              <td><a>: {{entry.number}}</a></td>
                            </tr>
                            <tr>
                              <td><a>MSG</a></td>
                              <td><a>: Working CH</a></td>
                            </tr>
                          </table>
                        </template>
                      </template>
                    </div>
                    <div class="select-indicator" vertical layout>
                      <a><font-awesome icon="circle"></font-awesome> ACCEPT</a>
                      <a><font-awesome icon="circle"></font-awesome>
                        <font-awesome icon="angle-up"></font-awesome>
                      </a>
                      <a><font-awesome icon="circle"></font-awesome>
                        <font-awesome icon="angle-down"></font-awesome>
                      </a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </div>
                  </template>

                  <template if="{{screenPage == 2}}">
                    <div flex vertical layout class="select-display">
                      <header>
                        Select ADD to</br>make a new call
                      </header>
                    </div>
                    <div class="select-indicator" vertical layout>
                      <a><font-awesome icon="circle"></font-awesome>
                        ADD
                      </a>
                      <a><font-awesome icon="circle"></font-awesome>
                        DELETE
                      </a>
                      <a><font-awesome icon="circle"></font-awesome>
                        <font-awesome icon="close"></font-awesome>
                      </a>
                      <a><font-awesome icon="circle"></font-awesome>
                        <font-awesome icon="mail-reply"></font-awesome>
                      </a>
                    </div>
                  </template>

                </div>
              </template>

              <template if="{{screen == 'call-addressbook-accept'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select send<br/>to transmit</header>
                    <br/>
                    <table>
                      <tr>
                        <td><a>TO</a></td>
                        <td><a>: {{callName}}</a></td>
                      </tr>
                      <tr>
                        <td><a>NUMBER</a></td>
                        <td><a>: {{number}}</a></td>
                      </tr>
                      <tr>
                        <td><a>CAT</a></td>
                        <td><a>: {{callType}}</a></td>
                      </tr>
                    </table>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> SEND</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                  </div>
                </div>
              </template>

              <template if="{{screen == 'distress-select'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select</br>nature of</br>distress</header>
                  </div>
                  <div class="select-indicator" vertical layout>

                    <template if="{{screenPage == 1}}">
                      <a><font-awesome icon="circle"></font-awesome> COLLISION</a>
                      <a><font-awesome icon="circle"></font-awesome> SINKING</a>
                      <a><font-awesome icon="circle"></font-awesome> PIRACY</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>
                    <template if="{{screenPage == 2}}">
                      <a><font-awesome icon="circle"></font-awesome> UNDESIGNATED</a>
                      <a><font-awesome icon="circle"></font-awesome> GROUNDING</a>
                      <a><font-awesome icon="circle"></font-awesome> MAN </br> OVERBOARD</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>
                    <template if="{{screenPage == 3}}">
                      <a><font-awesome icon="circle"></font-awesome> AMANDONING</br>SHIP</a>
                      <a><font-awesome icon="circle"></font-awesome> FLOODING</a>
                      <a><font-awesome icon="circle"></font-awesome> FIRE</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>
                    <template if="{{screenPage == 4}}">
                      <a><font-awesome icon="circle"></font-awesome> LISTING</a>
                      <a><font-awesome icon="circle"></font-awesome> DISABLED<br>AND ADRIFT</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>

                  </div>
                </div>
              </template>

              <template if="{{screen == 'extended-select'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select type of</br>exetended call</header>
                  </div>
                  <div class="select-indicator" vertical layout>

                    <template if="{{screenPage == 1}}">
                      <a><font-awesome icon="circle"></font-awesome> INDIVIDUAL</a>
                      <a><font-awesome icon="circle"></font-awesome> GROUP</a>
                      <a><font-awesome icon="circle"></font-awesome> G.AREA</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>
                    <template if="{{screenPage == 2}}">
                      <a><font-awesome icon="circle"></font-awesome> ALL SHIPS</a>
                      <a><font-awesome icon="circle"></font-awesome> DISTREE RELAY</a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                      <a><font-awesome icon="circle"></font-awesome><font-awesome icon="plus"></font-awesome></a>
                    </template>

                  </div>
                </div>
              </template>

              <template if="{{screen == 'rxlog'}}">
                <div horizontal layout>
                  <div flex vertical layout class="select-display">
                    <header>Select type of</br>message to view</header>
                    <br/>
                  </div>
                  <div class="select-indicator" vertical layout>
                    <a><font-awesome icon="circle"></font-awesome> CALLS</a>
                    <a><font-awesome icon="circle"></font-awesome> ALARM CALLS</a>
                    <a><font-awesome icon="circle"></font-awesome><font-awesome icon="close"></font-awesome></a>
                  </div>
                </div>
              </template>

            </div>
          </div>
          <div class="signals" horizontal layout around-justified>
            <div vertical layout align="center">
              <a>Tx</a>
              <font-awesome icon="circle" class="{{ {'signal-active': txind && on} | tokenList}}"></font-awesome>
            </div>
            <div vertical layout align="center">
              <a>1w</a>
              <font-awesome icon="circle" class="{{ {'signal-active': power == '1w' && on} | tokenList}}"></font-awesome>
            </div>
            <div vertical layout align="center">
              <a>US</a>
              <font-awesome icon="circle" class="{{ {'signal-active': !inter && on} | tokenList}}"></font-awesome>
            </div>
            <div vertical layout align="center">
              <a>CALL</a>
              <font-awesome icon="circle" class="{{ {'signal-active': callind && on} | tokenList}}"></font-awesome>
            </div>
            <div vertical layout align="center">
              <a>ALARM</a>
              <font-awesome icon="circle" class="{{ {'signal-active': alrmind && on} | tokenList}}"></font-awesome>
            </div>
          </div>
          <img src="./AHIL.png" width=80></img>
        </div>
        <div vertical layout>
          <div class="ctrl-actions" vertical layout>
            <template repeat="{{ button in ctrlbuttons}}">
              <font-awesome class="button" icon="caret-left" on-click={{clickCtrl}}></font-awesome>
            </template>
          </div>
        </div>
      </div>
      <!--rgb(250, 185, 84)-->
      <div class="ctrl-buttons" horizontal layout wrap>
        <div class="ctrl-commands" horizontal layout wrap>
          <div class="button" on-click={{clickRxLog}}>Rx</br>LOG</div>
          <div class="button" on-click={{clickTxCall}}>Tx</br>CALL</div>
          <div class="button" on-click={{clickAddrBook}}>ADDR</br>BOOK</div>
          <div class="button" on-click={{clickTelDsc}}>TEL/</br>DSC</div>
        </div>
      </div>
      <div class="ctrl-buttons" horizontal layout wrap>
        <div horizontal layout wrap>
          <webaudio-knob id="volume" class="knob" src="Gorethi2.png" sprites="19" min="0" max="100" width="80" height="80" value="{{volume}}"></webaudio-knob>
          <a>Volume</a>
          <webaudio-knob id="sq" class="knob" src="Gorethi2.png" sprites="19" min="0" max="100" diameter="120" width="80" height="80" value="{{sq}}"></webaudio-knob>
          <a>Sq</a>
          <div class="onoff-button button" on-click={{clickOnOff}}>ON/</br>OFF</div>
        </div>
      </div>
      <div class="dial-buttons" horizontal layout wrap>
        <template repeat="{{ dial in dialbuttons}}">
          <div class="button dial-button" horizontal layout on-click={{clickDial}}>
            <div><header>{{dial.command}}</header></br>{{dial.text}}</div>
            <div flex self-end class="number" align="bottom">{{dial.number}}</div>
          </div>
        </template>
        <div class="distress-wrapper">
          <div class="button distress-button" on-mousedown={{clickDistressStart}} on-touchstart={{clickDistressStart}} on-mouseup={{clickDistressStop}} on-touchend={{clickDistressStop}} flex-middle>
            <span><b>DISTRESS</b></span>
          </div>
        </div>
      </div>
    </div>


  </template>
  <script src="../underscore/underscore.js"></script>
  <script src="lib/SeamlessLoop.js"></script>
  <script src="lib/audiolib.js"></script>

  <script>

    Polymer({

      /**
       * `on`
       *
       * @property is device on
       * @type bool
       * @default false
       */
      on: false,

      /**
       * `channel` initial channel
       *
       * @property channel
       * @type int
       * @default 65
       */
      channel: 65,

      /**
       * `lightning` initial lightning
       *
       * @property lightning
       * @type int
       * @default 0
       */
      lightning: 0.5,

      /**
       * `mute` initially mute sound
       *
       * @property mute
       * @type bool
       * @default false
       */
      mute: false,

      /**
       * `volume` initial volume
       *
       * @property volume
       * @type int
       * @default 0
       */
      volume: 0,

      /**
       * `sq` initial squelch
       *
       * @property sq
       * @type int
       * @default 0
       */
      sq: 0,

      /**
       * `inter` inter
       *
       * @property inter
       * @type bool
       * @default false
       */
      inter: true,

      /**
       * `power` initial power
       *
       * @property power
       * @type string
       * @default 1w
       */
      power: "25w",

      /**
       * `screen` initial screen to show
       *
       * @property screen
       * @type string
       * @default home
       */
      screen: "tel",

      /**
       * `screenPage` initial screen page to show
       *
       * @property screenPage
       * @type int
       * @default 1
       */
      screenPage: 1,

      /**
       * `addressbook` addressbook
       *
       * @property addressbook
       * @type array
       * @default [{name: "RRC Koper",  number: "002780200"}]
       */
      addressbook: [
        {name: "RRC Koper", number: "002780200"},
        {name: "test", number: "002780201"}
      ],

      /**
       * `position` current gps position
       *
       * @property position
       * @type string
       * @default N:59째09 E:009째63
       */
      position: "N:59째09 E:009째63",

      txind: false,
      callind: false,
      alarmind: false,
      ctrlbuttons: [
        {"action": 1}, {"action": 2}, {"action": 3}, {"action": 4},
      ],
      dialbuttons: [
        {"number": 1, "command": "SCAN", "text": "ABC"},
        {"number": 2, "command": "STO", "text": "DEF"},
        {"number": 3, "command": "DEL", "text": "GHI"},
        {"number": 4, "command": "MEM", "text": "JKL"},
        {"number": 5, "command": "INT-C", "text": "DEF"},
        {"number": 6, "command": "DW", "text": "PQR"},
        {"number": 7, "command": "_", "text": "STU"},
        {"number": 8, "command": "_", "text": "VMW"},
        {"number": 9, "command": "_", "text": "YZ-"},
        {"number": "*", "command": "SHIFT", "text": ""},
        {"number": 0, "command": "FUNC", "text": "."},
        {"number": 16, "command": "P", "text": "#"}
      ],
      distressNatures: [
        "collision", "sinking", "piracy", "undesignated", "grounding",
        "man over board", "amandoning ship", "flooding", "fire", "listing",
        "disabled and adrift",
      ],
      message: '',
      number: '',
      callName: "",
      callRegion: "ship",
      callType: "Individual",
      notifficationMessage: "",
      previousScreen: "",
      distressTimeout: 0,
      distressTimer: null,
      addressbookId: 0,
      time: (new Date()).getUTCHours() + ":" + (new Date()).getUTCMinutes(),

      settings: {
        validChannels: _.union(_.range(29), _.range(60, 89))
      },

      ready: function() {
        // Ready is a lifecycle callback.
        // You can do setup work in here.
        // More info: http://www.polymer-project.org/docs/polymer/polymer.html#lifecyclemethods
        var that = this;

        // Generate noise
        var bufferSize = 4096,
            sampleRate  = 44100,
            playTime  = 10,
            playSize  = ~~(playTime * sampleRate);

        var color = 'white',
            buffer = new Float32Array(playSize),
            noise = new audioLib.Noise(sampleRate, color),
            fft = new audioLib.FFT(sampleRate, bufferSize / 2);

        for (i=0; i<playSize; i++){
          noise.generate();
          buffer[i] = fft.pushSample(noise.getMix());
        }

        var wav = audioLib.PCMData({
          data: buffer,
          sampleRate: sampleRate,
          channelCount: 1
        });

        // Create noise loop
        that.audio = new SeamlessLoop();
        that.audio.addUri('data:audio/wav;base64,' + btoa(wav), 10000, "noise");
        that.audio.callback(function() {
          that.audio.volume(that.volume * 1/100);
          that.playing = false;
          that.setMute();
        });
      },

      toUpperCase: function(value) {
        return value.toUpperCase();
      },

      clickDial: function(e, detail, sender) {
        var dial = e.target.templateInstance.model.dial;
        this.fire('dial-press', dial);

        switch (this.screen) {
          case 'tel':
            this.switchChannel(dial);
            break;
          case 'call':
            this.switchNumber(dial);
            break;
          case 'call-channel':
            this.switchChannel(dial);
            break;
          case 'call-group':
            this.switchChannel(dial);
            break;
        }
      },

      clickCtrl: function(e, detail, sender) {
        var button = e.target.templateInstance.model.button;
        this.fire('ctrl-press', button)

        switch (this.screen) {
          case 'tel':
            switch (button.action) {
              case 1:
                this.power = this.power == "25w" ? "1w" : "25w"
                break;
              case 2:
                this.inter = !this.inter;
                break;
              case 3:
                this.mute = !this.mute;
                break;
              case 4:
                this.lightning = ((this.lightning + 1/10) % 0.5);
                break;
            }
            break;
          case 'call-select':
            if (this.screenPage == 1) {
              switch (button.action) {
                case 1:
                  this.screen = 'call';
                  this.callType = 'Individual';
                  this.callRegion = 'shore';
                  break;
                case 2:
                  this.screen = 'call';
                  this.callType = 'Individual';
                  this.callRegion = 'ship';
                  break;
                case 4:
                  this.screenPage = 2;
                  break;
              }
            } else {
              switch (button.action) {
                case 1:
                  this.callType = 'Safety';
                  this.screen = 'call-group';
                  this.callRegion = 'All ships';
                  break;
                case 2:
                  this.screen = 'distress-select';
                  break;
                case 3:
                  this.screen = 'extended-select';
                  break;
                case 4:
                  this.screenPage = 1;
                  break;
              }
            }
            break;
          case 'call':
            switch (button.action) {
              case 1:
                if (this.number.length == 9) this.screen = 'call-channel';
                break;
              case 3:
                this.screen = 'call-select';
                break;
            }
            break;
          case 'call-channel':
            switch (button.action) {
              case 1:
                this.screen = 'call-accept';
                break;
              case 2:
                this.screen = 'call';
                break;
            }
            break;
          case 'call-group':
            switch (button.action) {
              case 1:
                this.screen = 'call-group-accept';
                break;
              case 2:
                this.screen = 'call-select';
                break;
            }
            break;
          case 'call-group-accept':
            switch (button.action) {
              case 1:
                this.screen = 'notiffication';
                this.previousScreen = this.screen;
                this.notifficationMessage = 'Transmitting';
                break;
              case 2:
                this.screen = 'call-group';
                break;
            }
            break;
          case 'call-accept':
            switch(button.action) {
              case 1:
                this.screen = 'notiffication';
                this.previousScreen = 'call-select';
                this.notifficationMessage = 'Transmitting';
                break;
              case 2:
                this.screen = 'call';
                break;
            }
            break;
          case 'notiffication':
            switch(button.action) {
              case 1:
                this.screen = this.previousScreen;
            }
            break;
          case 'distress-send':
            switch(button.action) {
              case 1:
                this.screen = this.previousScreen;
                break;
            }
            break;
          case 'addressbook':
            if (this.screenPage == 1) {
              switch(button.action) {
                case 1:
                  this.callType = "Routine";
                  this.callName = this.addressbook[this.screenPage].name;
                  this.number = this.addressbook[this.screenPage].number;
                  this.screen = 'call-addressbook-accept';
                  break;
                case 2:
                  this.addressbookId =
                    Math.abs(this.addressbookId - 1) % this.addressbook.length;
                  break;
                case 3:
                  this.addressbookId =
                    Math.abs(this.addressbookId + 1) % this.addressbook.length;
                  break;
                case 4:
                  this.screenPage = 2;
                  break
              }
            } else {
              switch(button.action) {
                case 3:
                  this.screen = 'tel';
                  break;
                default:
                  this.screenPage = 1;
              }
            }
            break;
          case 'call-addressbook-accept':
            switch(button.action) {
              case 1:
                this.notifficationMessage = "Transmitting";
                this.previousScreen = 'addressbook';
                this.screen = 'notiffication';
                break;
              case 2:
                this.screen = 'addressbook';
                break;
            }
            break;
          case 'distress-select':
            if (button.action == 4) {
              this.screenPage = this.screenPage % 4 + 1;
            } else {
              if (this.screenPage == 4 && button.action == 3) {
                this.screenPage = 1;
                this.screen = 'call-select';
              } else {
                this.distressNature = this.distressNatures[(this.screenPage-1)*3 + button.action - 1];
                this.distressTimeout = -1;
                this.screen = 'distress';
              }
            }
            break;
          case 'distress':
            switch(button.action) {
              case 1:
                this.previousScreen = 'tel';
                this.screen = 'distress-send';
                break;
              case 2:
                this.screen = 'distress-select';
                break;
            }
            break;
          case 'extended-select':
            if (button.action == 4) {
              this.screenPage = this.screenPage % 2 + 1;
            } else {
              if (this.screenPage == 2 && button.action == 3) {
                this.screenPage = 1;
                this.screen = 'call-select';
              }
            }
            break;
          case 'rxlog':
            switch(button.action) {
              case 3:
                this.screen = 'tel';
                break;
            }
        }
      },

      clickDistressStart: function() {
        var that = this;
        this.previousScreen = this.screen;
        this.distressNature = "Undesignated";
        this.distressTimeout = 5;
        this.distressTimer = setInterval(function () {
          that.distressTimeout -= 1;
          if (!that.distressTimeout) {
            that.screen = 'distress-send';
            clearInterval(that.distressTimer);
          }
        }, 1000);
        this.screen = 'distress';
      },

      clickDistressStop: function() {
        clearInterval(this.distressTimer);
        if (this.screen != 'distress-send')
          this.screen = this.previousScreen;
      },

      clickOnOff: function() {
        this.on = !this.on;
      },

      volumeChanged: function(old, vol) {
        this.audio.volume(vol * 1/100);
      },

      sqChanged: function(old, sq) {
        this.setMute();
      },

      muteChanged: function(old, muted) {
        this.setMute()
      },

      onChanged: function(old, on) {
        this.setMute();
      },

      screenChanged: function() {
        // Reset number for all pages, except for
        if (!_.contains(['call', 'call-channel', 'call-accept', 'notiffication', 'addressbook', 'call-addressbook-accept'], this.screen))
          this.number = "";

        if (
            (this.screen == 'notiffication' &&
             this.notifficationMessage == 'Transmitting') ||
            this.screen == 'distress-send'
        )
          this.txind = true;
        else
          this.txind = false;
      },

      setMute: function() {
        if(this.mute || !this.on || this.sq < 50) {
          if (this.playing)  {
            this.audio.stop();
            this.playing = false;
          }
        } else {
          if(!this.playing) {
            this.audio.start("noise");
            this.audio.volume(this.volume * 1/100);
          }
          this.playing = true;
        }
      },

      switchChannel: function (dial) {
        var newChannel = parseInt(this.channel.toString() + dial.number);
        if (_.indexOf(this.settings.validChannels, newChannel) > -1) {
          this.channel = newChannel;
        } else {
          this.channel = isNaN(parseInt(dial.number)) ? this.channel : parseInt(dial.number);
        }
      },

      switchNumber: function(dial) {
        var newNumber = this.number + dial.number;
        if (newNumber.length > 9) return;
        this.number = newNumber;
      },

      clickTelDsc: function () {
        this.screen = this.screen == "tel" ? "dsc" : "tel";
      },

      clickTxCall: function() {
        this.screenPage = 1;
        this.screen = "call-select";
      },

      clickAddrBook: function() {
        this.screenPage = 1;
        this.screen = 'addressbook';
        this.addressbookId = 0;
      },

      clickRxLog: function() {
        this.screenPage = 1;
        this.screen = 'rxlog';
      }
    });

  </script>

</polymer-element>
